# ETR-290 Analysis Implementation

## 1. 개요 (Overview)
본 문서는 MPEG2-TS 스트림의 무결성을 검증하기 위한 **ETR-290 (Measurement guidelines for DVB systems)** 규격 구현에 대한 기술 문서입니다.  
Priority 1 (Critical) 및 Priority 2 (Recommended) 항목에 대한 에러 체크 및 통계 분석 기능을 제공합니다.

## 2. 지원 항목 (Features)

### Priority 1 (Decodability Critical)
| 항목 | 설명 | 구현 방식 |
|---|---|---|
| **TS_sync_loss** | 5개 이상의 연속된 Sync Byte(0x47) 손실 | (File Scan 특성상 Sync Byte Error로 대체) |
| **Sync_byte_error** | 0x47이 아닌 값 검출 | 패킷 첫 바이트 검사 |
| **PAT_error** | PID 0x0000 부재, Interval > 0.5s, TableID!=0 | Interval 및 Scramble Check 구현 |
| **Continuity_count_error** | 패킷 손실, 순서 뒤바뀜 | PID별 Continuity Counter 추적 (Duplicate 허용) |
| **PMT_error** | PMT PID 부재, Interval > 0.5s | PAT 파싱 후 등록된 PMT PID 추적 |
| **PID_error** | 참조된 PID가 일정 시간 동안 미수신 | (Optional) |

### Priority 2 (Recommended Monitoring)
| 항목 | 설명 | 구현 방식 |
|---|---|---|
| **Transport_error** | TEI (Transport Error Indicator) 플래그가 1 | 헤더 파싱 시 체크 |
| **CRC_error** | PSI/SI 테이블의 CRC32 오류 | (구현 예정) |
| **PCR_repetition_error** | PCR 전송 간격 > 40ms | PCR 패킷 간 바이트 거리 기반 시간 환산 |
| **PCR_discontinuity_error** | PCR 값의 불연속성 (> 100ms) | 이전 PCR 값과의 차이 계산 |
| **PCR_accuracy_error** | PCR Jitter 허용치(±500ns) 초과 | **TSJitterAnalyzer** 모듈과 연동하여 측정 |
| **PTS_error** | PTS 전송 간격 > 700ms | PUSI=1 패킷의 PTS 간격 체크 |
| **CAT_error** | Scrambled 패킷 존재 시 CAT 부재 | Scramble Control 비트 확인 |

## 3. 구현 구조 (Architecture)

### 3.1. `TSETR290Analyzer` Class (`scripts/ts_etr290_analyzer.py`)
*   **역할**: ETR-290 상태 머신 및 에러 카운터 관리.
*   **동작 방식**:
    1.  `process_packet()`: 개별 패킷 단위로 Sync, TEI, CC Error 등을 즉시 판별.
    2.  `finalize_analysis()`: 전체 파일 스캔이 끝난 후, 수집된 Offset 정보를 이용해 Interval(시간) 관련 에러를 일괄 계산.
    3.  `get_report_markdown()`: 분석 결과를 Markdown 포맷으로 출력 (Min/Max/Avg Interval 통계 포함).

### 3.2. 통합 (Integration)
*   **TSScanner**: 백그라운드 스캔 시 `etr290` 인스턴스를 생성하여 패킷 데이터를 주입.
*   **Jitter Analysis**: `TSScanner`가 `TSJitterAnalyzer`를 통해 계산한 Jitter 결과를 `etr290` 객체에 전달하여 `PCR_accuracy_error` 판정에 활용.

## 4. 리포트 (Reporting)
분석 결과는 `BScan` 리포트에 포함되며, 다음과 같은 상세 정보를 제공합니다:
*   **Status**: OK / Error Count
*   **Statistics**:
    *   **PCR Interval**: Min/Max/Avg (ms)
    *   **PTS Interval**: Min/Max/Avg (ms)
    *   **PAT/PMT Interval**: Min/Max/Avg (ms)
    *   **Jitter**: Timing Jitter, Alignment Jitter (Max ns)
